---
phase: 03-script-execution
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [Exmen/Services/OutputHandler.swift, Exmen/Views/PopupResultView.swift, Exmen/Views/ActionRowView.swift, Exmen/Views/MenuContentView.swift]
---

<objective>
Implement output handlers for clipboard, notification, and popup display.

Purpose: Handle script results according to action configuration.
Output: Working output handlers that copy to clipboard, show notifications, or display popups.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-script-execution/03-01-SUMMARY.md

**Output handlers:**
- clipboard: Copy output to system clipboard
- notification: Show macOS notification with output
- popup: Display output in a popup window
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OutputHandler service</name>
  <files>Exmen/Services/OutputHandler.swift</files>
  <action>
Create the output handler service:

```swift
import Foundation
import AppKit
import UserNotifications

/// Service for handling script output
class OutputHandler {
    static let shared = OutputHandler()

    private init() {
        // Request notification permissions
        requestNotificationPermission()
    }

    /// Handle script result based on output config
    func handle(_ result: ScriptResult, config: OutputConfig, actionName: String) {
        let output = result.trimmedOutput

        switch config.handler {
        case .clipboard:
            copyToClipboard(output)
        case .notification:
            showNotification(title: actionName, body: output, isError: !result.isSuccess)
        case .popup:
            // Popup is handled by the view layer
            break
        }
    }

    /// Copy text to system clipboard
    func copyToClipboard(_ text: String) {
        let pasteboard = NSPasteboard.general
        pasteboard.clearContents()
        pasteboard.setString(text, forType: .string)
    }

    /// Show macOS notification
    func showNotification(title: String, body: String, isError: Bool = false) {
        let content = UNMutableNotificationContent()
        content.title = isError ? "⚠️ \(title)" : "✓ \(title)"
        content.body = body.isEmpty ? (isError ? "Script failed" : "Completed") : body
        content.sound = isError ? .defaultCritical : .default

        let request = UNNotificationRequest(
            identifier: UUID().uuidString,
            content: content,
            trigger: nil
        )

        UNUserNotificationCenter.current().add(request) { error in
            if let error = error {
                print("Failed to show notification: \(error)")
            }
        }
    }

    /// Request notification permission
    private func requestNotificationPermission() {
        UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound]) { granted, error in
            if let error = error {
                print("Notification permission error: \(error)")
            }
        }
    }
}
```
  </action>
  <verify>OutputHandler.swift exists with clipboard, notification methods</verify>
  <done>OutputHandler service created</done>
</task>

<task type="auto">
  <name>Task 2: Create PopupResultView</name>
  <files>Exmen/Views/PopupResultView.swift</files>
  <action>
Create a view for displaying script output in a popup:

```swift
import SwiftUI

/// View for displaying script result in a popup
struct PopupResultView: View {
    let actionName: String
    let result: ScriptResult
    let onDismiss: () -> Void

    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Image(systemName: result.isSuccess ? "checkmark.circle.fill" : "xmark.circle.fill")
                    .foregroundColor(result.isSuccess ? .green : .red)
                Text(actionName)
                    .font(.headline)
                Spacer()
                Button(action: onDismiss) {
                    Image(systemName: "xmark")
                        .foregroundColor(.secondary)
                }
                .buttonStyle(.plain)
            }
            .padding()

            Divider()

            // Output content
            ScrollView {
                VStack(alignment: .leading, spacing: 8) {
                    if !result.output.isEmpty {
                        Text(result.output)
                            .font(.system(.body, design: .monospaced))
                            .textSelection(.enabled)
                            .frame(maxWidth: .infinity, alignment: .leading)
                    }

                    if !result.error.isEmpty {
                        Text(result.error)
                            .font(.system(.body, design: .monospaced))
                            .foregroundColor(.red)
                            .textSelection(.enabled)
                            .frame(maxWidth: .infinity, alignment: .leading)
                    }

                    if result.output.isEmpty && result.error.isEmpty {
                        Text("No output")
                            .foregroundColor(.secondary)
                            .italic()
                    }
                }
                .padding()
            }

            Divider()

            // Footer
            HStack {
                Text("Exit code: \(result.exitCode)")
                    .font(.caption)
                    .foregroundColor(.secondary)
                Text("•")
                    .foregroundColor(.secondary)
                Text(String(format: "%.2fs", result.duration))
                    .font(.caption)
                    .foregroundColor(.secondary)
                Spacer()
                Button("Copy") {
                    OutputHandler.shared.copyToClipboard(result.trimmedOutput)
                }
                Button("Close") {
                    onDismiss()
                }
                .keyboardShortcut(.escape, modifiers: [])
            }
            .padding(12)
        }
        .frame(width: 400, height: 300)
    }
}
```
  </action>
  <verify>PopupResultView.swift exists with result display</verify>
  <done>PopupResultView created for popup output display</done>
</task>

<task type="auto">
  <name>Task 3: Update MenuContentView with execution logic</name>
  <files>Exmen/Views/MenuContentView.swift</files>
  <action>
Update MenuContentView to handle action execution and show popups:

```swift
import SwiftUI

struct MenuContentView: View {
    @ObservedObject private var actionService = ActionService.shared
    @State private var executingActionId: UUID?
    @State private var popupResult: (action: Action, result: ScriptResult)?

    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Image(systemName: "terminal.fill")
                    .foregroundColor(.accentColor)
                Text("Exmen")
                    .font(.headline)
                Spacer()
                Button(action: {
                    actionService.refresh()
                }) {
                    Image(systemName: "arrow.clockwise")
                        .font(.caption)
                }
                .buttonStyle(.plain)
                .help("Reload actions")
            }
            .padding()

            Divider()

            // Actions list or popup
            if let popup = popupResult {
                PopupResultView(
                    actionName: popup.action.name,
                    result: popup.result,
                    onDismiss: { popupResult = nil }
                )
            } else if actionService.isLoading {
                ProgressView()
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else if actionService.actions.isEmpty {
                Text("No actions configured")
                    .foregroundColor(.secondary)
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                ScrollView {
                    LazyVStack(spacing: 4) {
                        ForEach(actionService.actions) { action in
                            ActionRowView(
                                action: action,
                                isExecuting: executingActionId == action.id,
                                onExecute: { executeAction(action) }
                            )
                        }
                    }
                    .padding(.vertical, 8)
                    .padding(.horizontal, 12)
                }
            }

            Divider()

            // Footer
            HStack {
                Text("v1.0")
                    .font(.caption)
                    .foregroundColor(.secondary)
                Spacer()
                Button("Quit") {
                    NSApp.terminate(nil)
                }
                .keyboardShortcut("q", modifiers: .command)
            }
            .padding(12)
        }
        .frame(width: popupResult != nil ? 400 : 280, height: popupResult != nil ? 350 : 320)
    }

    private func executeAction(_ action: Action) {
        guard let scriptConfig = action.scriptConfig else {
            print("No script config for action: \(action.name)")
            return
        }

        executingActionId = action.id

        Task {
            do {
                let result = try await ScriptRunner.shared.run(scriptConfig)

                await MainActor.run {
                    executingActionId = nil
                    handleResult(result, for: action)
                }
            } catch {
                await MainActor.run {
                    executingActionId = nil
                    let errorResult = ScriptResult(
                        output: "",
                        error: error.localizedDescription,
                        exitCode: -1,
                        duration: 0
                    )
                    handleResult(errorResult, for: action)
                }
            }
        }
    }

    private func handleResult(_ result: ScriptResult, for action: Action) {
        switch action.outputConfig.handler {
        case .clipboard:
            OutputHandler.shared.handle(result, config: action.outputConfig, actionName: action.name)
            // Show brief notification for clipboard
            if result.isSuccess {
                OutputHandler.shared.showNotification(
                    title: action.name,
                    body: "Copied to clipboard",
                    isError: false
                )
            }
        case .notification:
            OutputHandler.shared.handle(result, config: action.outputConfig, actionName: action.name)
        case .popup:
            popupResult = (action, result)
        }
    }
}

struct ActionRowView: View {
    let action: Action
    let isExecuting: Bool
    let onExecute: () -> Void

    @State private var isHovered = false

    var body: some View {
        Button(action: onExecute) {
            HStack(spacing: 12) {
                if isExecuting {
                    ProgressView()
                        .scaleEffect(0.7)
                        .frame(width: 20)
                } else {
                    Image(systemName: action.icon)
                        .frame(width: 20)
                        .foregroundColor(.accentColor)
                }

                VStack(alignment: .leading, spacing: 2) {
                    Text(action.name)
                        .font(.body)
                    if !action.description.isEmpty {
                        Text(action.description)
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }

                Spacer()

                Image(systemName: "play.fill")
                    .font(.caption)
                    .foregroundColor(.secondary)
                    .opacity(isHovered && !isExecuting ? 1 : 0)
            }
            .padding(.vertical, 8)
            .padding(.horizontal, 12)
            .background(isHovered ? Color.accentColor.opacity(0.1) : Color.clear)
            .cornerRadius(6)
        }
        .buttonStyle(.plain)
        .disabled(isExecuting)
        .onHover { hovering in
            isHovered = hovering
        }
    }
}

#Preview {
    MenuContentView()
}
```
  </action>
  <verify>MenuContentView has executeAction, handleResult, and popup state</verify>
  <done>MenuContentView updated with execution and output handling</done>
</task>

<task type="auto">
  <name>Task 4: Update Xcode project with new files</name>
  <files>Exmen.xcodeproj/project.pbxproj</files>
  <action>
Add OutputHandler.swift and PopupResultView.swift to the Xcode project.
  </action>
  <verify>All files in project and build succeeds</verify>
  <done>Xcode project updated</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] OutputHandler.swift exists with clipboard/notification handling
- [ ] PopupResultView.swift exists for popup display
- [ ] MenuContentView.swift updated with execution logic
- [ ] All files added to Xcode project
- [ ] Project builds successfully
- [ ] Clicking an action executes its script
</verification>

<success_criteria>
- All tasks completed
- Clipboard handler copies output
- Notification handler shows macOS notification
- Popup handler displays result in view
- Loading spinner shows during execution
- Errors handled gracefully
- Phase 3 Script Execution complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-script-execution/03-02-SUMMARY.md`

Note: This completes Phase 3. Mark phase as complete in ROADMAP.md progress table.
</output>
