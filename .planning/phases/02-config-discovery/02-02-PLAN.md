---
phase: 02-config-discovery
plan: 02
type: execute
depends_on: ["02-01"]
files_modified: [Exmen/Services/DirectoryWatcher.swift, Exmen/Services/ActionService.swift, Exmen/Views/MenuContentView.swift, Exmen/ExmenApp.swift]
---

<objective>
Implement directory watching and ActionService to auto-reload actions when config files change.

Purpose: Make the app reactive to config changes without requiring restart.
Output: ActionService that loads configs on startup and watches for changes.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-config-discovery/02-RESEARCH.md
@.planning/phases/02-config-discovery/02-01-SUMMARY.md

**From RESEARCH.md:**
- Use DispatchSource for directory watching (simpler than FSEvents)
- Watch for .write, .delete, .rename events
- Must close file descriptor in cancelHandler to avoid leaks
- Debounce rapid changes to avoid excessive reloads
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DirectoryWatcher class</name>
  <files>Exmen/Services/DirectoryWatcher.swift</files>
  <action>
Create the directory watcher using DispatchSource:

```swift
import Foundation

/// Watches a directory for file system changes
class DirectoryWatcher {
    private var source: DispatchSourceFileSystemObject?
    private var fileDescriptor: Int32 = -1
    private let path: String
    private let callback: () -> Void

    // Debounce to avoid multiple rapid callbacks
    private var debounceWorkItem: DispatchWorkItem?
    private let debounceInterval: TimeInterval

    init(path: String, debounceInterval: TimeInterval = 0.5, callback: @escaping () -> Void) {
        self.path = NSString(string: path).expandingTildeInPath
        self.debounceInterval = debounceInterval
        self.callback = callback
    }

    /// Start watching the directory
    func start() -> Bool {
        // Open file descriptor for the directory
        fileDescriptor = open(path, O_EVTONLY)
        guard fileDescriptor >= 0 else {
            print("DirectoryWatcher: Failed to open \(path)")
            return false
        }

        // Create dispatch source
        source = DispatchSource.makeFileSystemObjectSource(
            fileDescriptor: fileDescriptor,
            eventMask: [.write, .delete, .rename, .extend, .attrib],
            queue: .main
        )

        source?.setEventHandler { [weak self] in
            self?.handleEvent()
        }

        source?.setCancelHandler { [weak self] in
            if let fd = self?.fileDescriptor, fd >= 0 {
                close(fd)
                self?.fileDescriptor = -1
            }
        }

        source?.resume()
        print("DirectoryWatcher: Started watching \(path)")
        return true
    }

    /// Stop watching
    func stop() {
        debounceWorkItem?.cancel()
        source?.cancel()
        source = nil
    }

    /// Handle file system event with debouncing
    private func handleEvent() {
        // Cancel any pending callback
        debounceWorkItem?.cancel()

        // Schedule new callback after debounce interval
        let workItem = DispatchWorkItem { [weak self] in
            self?.callback()
        }
        debounceWorkItem = workItem

        DispatchQueue.main.asyncAfter(
            deadline: .now() + debounceInterval,
            execute: workItem
        )
    }

    deinit {
        stop()
    }
}
```
  </action>
  <verify>DirectoryWatcher.swift exists with start(), stop(), and debouncing</verify>
  <done>DirectoryWatcher created with DispatchSource and debouncing</done>
</task>

<task type="auto">
  <name>Task 2: Create ActionService with ObservableObject</name>
  <files>Exmen/Services/ActionService.swift</files>
  <action>
Create the main service that manages actions:

```swift
import Foundation
import SwiftUI

/// Main service for managing actions
/// Loads from config files and watches for changes
@MainActor
class ActionService: ObservableObject {
    static let shared = ActionService()

    @Published var actions: [Action] = []
    @Published var isLoading = false
    @Published var lastError: String?

    private let configLoader = ConfigLoader.shared
    private var directoryWatcher: DirectoryWatcher?

    private init() {}

    /// Initialize the service - load actions and start watching
    func initialize() {
        // Ensure config directory exists
        _ = configLoader.ensureConfigDirectory()

        // Load initial actions
        loadActions()

        // Start watching for changes
        startWatching()
    }

    /// Load actions from config files
    func loadActions() {
        isLoading = true
        lastError = nil

        let configs = configLoader.loadAllConfigs()

        if configs.isEmpty {
            // Fall back to sample actions if no configs found
            actions = Action.samples
            print("ActionService: No configs found, using sample actions")
        } else {
            actions = configs.map { Action(from: $0) }
            print("ActionService: Loaded \(actions.count) actions from config")
        }

        isLoading = false
    }

    /// Start watching the config directory for changes
    func startWatching() {
        directoryWatcher = DirectoryWatcher(
            path: configLoader.configDirectory
        ) { [weak self] in
            print("ActionService: Config directory changed, reloading...")
            self?.loadActions()
        }

        if directoryWatcher?.start() == false {
            print("ActionService: Could not start directory watcher")
        }
    }

    /// Stop watching for changes
    func stopWatching() {
        directoryWatcher?.stop()
        directoryWatcher = nil
    }

    /// Manually trigger a reload
    func refresh() {
        loadActions()
    }
}
```
  </action>
  <verify>ActionService.swift exists with initialize(), loadActions(), startWatching()</verify>
  <done>ActionService created with ObservableObject and directory watching</done>
</task>

<task type="auto">
  <name>Task 3: Update MenuContentView to use ActionService</name>
  <files>Exmen/Views/MenuContentView.swift</files>
  <action>
Update MenuContentView to use ActionService instead of static actions:

```swift
import SwiftUI

struct MenuContentView: View {
    @ObservedObject private var actionService = ActionService.shared

    var body: some View {
        VStack(spacing: 0) {
            // Header
            HStack {
                Image(systemName: "terminal.fill")
                    .foregroundColor(.accentColor)
                Text("Exmen")
                    .font(.headline)
                Spacer()
                // Refresh button
                Button(action: {
                    actionService.refresh()
                }) {
                    Image(systemName: "arrow.clockwise")
                        .font(.caption)
                }
                .buttonStyle(.plain)
                .help("Reload actions")
            }
            .padding()

            Divider()

            // Actions list
            if actionService.isLoading {
                ProgressView()
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else if actionService.actions.isEmpty {
                Text("No actions configured")
                    .foregroundColor(.secondary)
                    .frame(maxWidth: .infinity, maxHeight: .infinity)
            } else {
                ScrollView {
                    LazyVStack(spacing: 4) {
                        ForEach(actionService.actions) { action in
                            ActionRowView(action: action)
                        }
                    }
                    .padding(.vertical, 8)
                    .padding(.horizontal, 12)
                }
            }

            Divider()

            // Footer with quit button
            HStack {
                Text("v1.0")
                    .font(.caption)
                    .foregroundColor(.secondary)
                if let error = actionService.lastError {
                    Text(error)
                        .font(.caption)
                        .foregroundColor(.red)
                }
                Spacer()
                Button("Quit") {
                    NSApp.terminate(nil)
                }
                .keyboardShortcut("q", modifiers: .command)
            }
            .padding(12)
        }
        .frame(width: 280, height: 320)
    }
}

struct ActionRowView: View {
    let action: Action
    @State private var isHovered = false

    var body: some View {
        Button(action: {
            // Will execute action in Phase 3
            print("Clicked: \(action.name)")
        }) {
            HStack(spacing: 12) {
                Image(systemName: action.icon)
                    .frame(width: 20)
                    .foregroundColor(.accentColor)

                VStack(alignment: .leading, spacing: 2) {
                    Text(action.name)
                        .font(.body)
                    if !action.description.isEmpty {
                        Text(action.description)
                            .font(.caption)
                            .foregroundColor(.secondary)
                    }
                }

                Spacer()

                Image(systemName: "play.fill")
                    .font(.caption)
                    .foregroundColor(.secondary)
                    .opacity(isHovered ? 1 : 0)
            }
            .padding(.vertical, 8)
            .padding(.horizontal, 12)
            .background(isHovered ? Color.accentColor.opacity(0.1) : Color.clear)
            .cornerRadius(6)
        }
        .buttonStyle(.plain)
        .onHover { hovering in
            isHovered = hovering
        }
    }
}

#Preview {
    MenuContentView()
}
```
  </action>
  <verify>MenuContentView uses @ObservedObject ActionService.shared</verify>
  <done>MenuContentView updated to use ActionService</done>
</task>

<task type="auto">
  <name>Task 4: Update ExmenApp to initialize ActionService</name>
  <files>Exmen/ExmenApp.swift</files>
  <action>
Update the app entry point to initialize ActionService:

```swift
import SwiftUI

@main
struct ExmenApp: App {
    init() {
        // Initialize the action service
        ActionService.shared.initialize()
    }

    var body: some Scene {
        MenuBarExtra("Exmen", systemImage: "terminal.fill") {
            MenuContentView()
        }
        .menuBarExtraStyle(.window)
    }
}
```
  </action>
  <verify>ExmenApp.swift calls ActionService.shared.initialize() in init</verify>
  <done>ExmenApp initializes ActionService on startup</done>
</task>

<task type="auto">
  <name>Task 5: Create sample TOML config files</name>
  <files>~/.config/exmen/actions/</files>
  <action>
Create sample TOML config files for testing:

**File 1: ~/.config/exmen/actions/generate-phone.toml**
```toml
name = "Generate Phone Number"
icon = "phone"
description = "Generate random Thai phone number"

[script]
type = "inline"
content = """
#!/bin/bash
printf "08%08d" $((RANDOM % 100000000))
"""

[output]
handler = "clipboard"
```

**File 2: ~/.config/exmen/actions/disk-space.toml**
```toml
name = "Check Disk Space"
icon = "internaldrive"
description = "Show available disk space"

[script]
type = "inline"
content = """
#!/bin/bash
df -h / | awk 'NR==2 {print $4 " available"}'
"""

[output]
handler = "notification"
```

**File 3: ~/.config/exmen/actions/brew-update.toml**
```toml
name = "Update Homebrew"
icon = "arrow.clockwise"
description = "Run brew update && upgrade"

[script]
type = "inline"
content = """
#!/bin/bash
brew update && brew upgrade
"""

[output]
handler = "popup"
```
  </action>
  <verify>Sample .toml files exist in ~/.config/exmen/actions/</verify>
  <done>Sample TOML config files created</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] DirectoryWatcher.swift exists with debouncing
- [ ] ActionService.swift exists with ObservableObject
- [ ] MenuContentView.swift uses ActionService
- [ ] ExmenApp.swift initializes ActionService
- [ ] Sample TOML files exist in ~/.config/exmen/actions/
- [ ] App loads actions from TOML on startup
- [ ] Adding/removing .toml files triggers reload
</verification>

<success_criteria>
- All tasks completed
- Actions load from ~/.config/exmen/actions/*.toml
- Falls back to sample actions if no configs found
- Directory watcher auto-reloads on file changes
- Refresh button manually reloads actions
- Phase 2 Config & Discovery complete
</success_criteria>

<output>
After completion, create `.planning/phases/02-config-discovery/02-02-SUMMARY.md`

Note: This completes Phase 2. Mark phase as complete in ROADMAP.md progress table.
</output>
