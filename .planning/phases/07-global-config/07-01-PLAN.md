---
phase: 07-global-config
plan: 01
type: execute
depends_on: []
files_modified: [Exmen/Models/GlobalConfig.swift, Exmen/Services/ConfigLoader.swift, Exmen/Services/ActionService.swift, Exmen.xcodeproj/project.pbxproj]
---

<objective>
Add global config.toml for controlling action ordering and enable/disable.

Purpose: Let users control which actions appear and in what order without modifying individual action files.
Output: Working config.toml support at ~/.config/exmen/config.toml
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Exmen/Services/ConfigLoader.swift
@Exmen/Services/ActionService.swift
@Exmen/Models/ActionConfig.swift

**Established patterns:**
- TOMLDecoder for TOML parsing (already in project)
- DirectoryWatcher for file change detection
- ConfigLoader for loading TOML files

**Config file location:** ~/.config/exmen/config.toml (same directory as actions/)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GlobalConfig model</name>
  <files>Exmen/Models/GlobalConfig.swift</files>
  <action>
  Create GlobalConfig.swift with Codable struct:

  ```swift
  struct GlobalConfig: Codable {
      var order: [String]?      // Action names in display order
      var disabled: [String]?   // Action names to hide
  }
  ```

  Add to ConfigLoader:
  - Property: `globalConfigPath` pointing to ~/.config/exmen/config.toml
  - Method: `loadGlobalConfig() -> GlobalConfig?` using TOMLDecoder

  Add new file to Xcode project.pbxproj (PBXBuildFile, PBXFileReference, Models group, Sources build phase).
  </action>
  <verify>Project builds without errors</verify>
  <done>GlobalConfig model exists and can be decoded from TOML</done>
</task>

<task type="auto">
  <name>Task 2: Apply ordering and filtering in ActionService</name>
  <files>Exmen/Services/ActionService.swift</files>
  <action>
  Modify loadActions() to:

  1. Load global config: `let globalConfig = configLoader.loadGlobalConfig()`
  2. Filter out disabled actions:
     ```swift
     let disabled = Set(globalConfig?.disabled ?? [])
     let enabledActions = configs.filter { !disabled.contains($0.name) }
     ```
  3. Apply ordering:
     ```swift
     let order = globalConfig?.order ?? []
     let orderMap = Dictionary(uniqueKeysWithValues: order.enumerated().map { ($1, $0) })
     let sorted = enabledActions.sorted {
         let idx1 = orderMap[$0.name] ?? Int.max
         let idx2 = orderMap[$1.name] ?? Int.max
         return idx1 < idx2
     }
     ```
  4. Actions not in order list appear at the end (in filesystem order)
  </action>
  <verify>
  1. Create test config.toml with order and disabled arrays
  2. Verify actions appear in specified order
  3. Verify disabled actions don't appear
  </verify>
  <done>Actions are ordered and filtered according to config.toml</done>
</task>

<task type="auto">
  <name>Task 3: Watch config.toml for changes</name>
  <files>Exmen/Services/ActionService.swift, Exmen/Services/ConfigLoader.swift</files>
  <action>
  Add file watching for config.toml:

  1. In ConfigLoader, add method to get parent config directory: `~/.config/exmen/`
  2. In ActionService.startWatching(), also watch for config.toml changes
     - Option A: Watch the parent directory (~/.config/exmen/) for all changes
     - Option B: Add second DirectoryWatcher for config.toml specifically

  Choose Option A (simpler) - modify existing watcher to watch parent directory and reload on any .toml file change.

  Update DirectoryWatcher path from `~/.config/exmen/actions` to `~/.config/exmen` and filter for .toml changes.
  </action>
  <verify>
  1. Edit config.toml while app is running
  2. Verify actions list updates automatically
  </verify>
  <done>Changes to config.toml trigger automatic reload</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild -scheme Exmen build` succeeds
- [ ] Create ~/.config/exmen/config.toml with test content
- [ ] Actions appear in order specified
- [ ] Disabled actions don't appear
- [ ] Editing config.toml triggers reload
</verification>

<success_criteria>

- All tasks completed
- GlobalConfig model created and integrated
- Action ordering works as specified
- Action disable works as specified
- File watching triggers reload on config.toml changes
</success_criteria>

<output>
After completion, create `.planning/phases/07-global-config/07-01-SUMMARY.md`

Example config.toml format:
```toml
# Action display order (actions not listed appear at end)
order = [
    "System Status",
    "Generate Phone Number",
    "Update Homebrew"
]

# Actions to hide (by name)
disabled = [
    "Check Disk Space"
]
```
</output>
